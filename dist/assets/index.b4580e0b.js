import{z as t,l as e,t as s,a as n,b as i,s as r,c as o,d as a,e as h}from"./vendor.d358b7f1.js";!function(t=".",e="__import__"){try{self[e]=new Function("u","return import(u)")}catch(s){const n=new URL(t,location),i=t=>{URL.revokeObjectURL(t.src),t.remove()};self[e]=t=>new Promise(((s,r)=>{const o=new URL(t,n);if(self[e].moduleMap[o])return s(self[e].moduleMap[o]);const a=new Blob([`import * as m from '${o}';`,`${e}.moduleMap['${o}']=m;`],{type:"text/javascript"}),h=Object.assign(document.createElement("script"),{type:"module",src:URL.createObjectURL(a),onerror(){r(new Error(`Failed to import: ${t}`)),i(h)},onload(){s(self[e].moduleMap[o]),i(h)}});document.head.appendChild(h)})),self[e].moduleMap={}}}("/tiny-stuffengine/dist/assets/");const l=document.querySelector("#app");l.style.height="10000px",l.style.width="10000px";const u=document.createElement("div");document.body.append(u);class c{constructor(t){this.stuff=t}get Components(){return new Set(this.stuff.components.keys())}get Context(){return this.stuff.context}get Element(){return this.stuff.element}getComponent(t){var e;return null==(e=this.stuff.components.get(t))?void 0:e.exports}}class f{constructor(){this._stuff=null,this._context=null,this.Stuff=null,this.Context=null,this.props=new Map,this.requirements=[]}beforeAttach(t){this._stuff=t,this.Stuff=new c(this._stuff)}}class p extends f{constructor(){super(...arguments),this.name="render",this.position=t([3]),this.size=t([2]),this.rotate=t([3]),this.rotateUnit="deg",this.exports={setPosition:t=>{e.assert(3==t.shape[0]),this.position=t.clone()},getPosition:()=>this.position,setSize:t=>{e.assert(2==t.shape[0]),this.size=t.clone()},setRotate:(t,e="deg")=>{this.exports.setAxisRotate(s([0,0,t]),e)},setAxisRotate:(t,e="deg")=>{this.rotate=t.clone(),this.rotateUnit=e}}}beforeAttach(t){super.beforeAttach(t)}render(t){if(null!=this._stuff&&this.Stuff){let t=this.Stuff.Element,e=this.position.arraySync(),s=this.size.arraySync(),n=this.rotate.arraySync(),i=this.rotateUnit;t.style.height=`${s[0]}px`,t.style.width=`${s[1]}px`,t.style.willChange="transform";let r=`translate(${e[0]}px,${e[1]}px) rotateX(${n[0]}${i}) rotateY(${n[1]}${i}) rotateZ(${n[2]}${i})`;t.style.transform=r}}}class m extends f{constructor(){super(...arguments),this.name="mechanics",this.m=1,this.E=t=>n([[1,t,0,0],[0,1,t,0],[0,0,0,1/this.m],[0,0,0,1]]),this.X=t([4,3]),this.addF=t=>{3==t.shape[0]&&(this.X=this.X.add(i([[0,0,0],[0,0,0],[0,0,0],[...t.arraySync()]])))},this.setF=t=>{this.X=this.X.mul(n([[1,1,0]])),this.addF(t)},this.setXState=(t=null,s=null,n=null,i=null)=>{4==[t,s,n,i].filter((t=>null==t||3==t.shape[0])).length?(t=null!=t?t:this.X.slice(0,1).as1D(),s=null!=s?s:this.X.slice(1,1).as1D(),n=null!=n?n:this.X.slice(2,1).as1D(),i=null!=i?i:this.X.slice(3,1).as1D(),this.X=r([t,s,n,i])):e.error("错误,维度错误")},this.getState=t=>{switch(t){case"Pos":return this.X.slice(0,1).as1D();case"V":return this.X.slice(1,1).as1D();case"ACC":return this.X.slice(2,1).as1D();case"F":return this.X.slice(3,1).as1D()}},this.exports={getState:this.getState,setF:this.setF,addF:this.addF,setState:this.setXState,setM:t=>this.m=t,getM:()=>this.m}}toNext(t){const e=o((()=>this.E(t)));let s=this.X;this.X=e.matMul(this.X),e.dispose(),s.dispose()}beforeAttach(t){super.beforeAttach(t)}render(t){if(null==this._stuff)return;if(null==t)return;this.toNext(t/1e3);let e=this.X.slice(0,1).as1D();if(this.Stuff){this.Stuff.getComponent("render").setPosition(e);let t=o((()=>this.getState("V").norm().asScalar())),s=o((()=>i(.5*this.m).mul(t.pow(2))));this.Stuff.Element.innerText=`质量:${this.m.toString()} 速度:${t.arraySync().toString()} 动能:${s.arraySync().toString()}`,t.dispose(),s.dispose()}e.dispose()}}class d extends f{constructor(){super(...arguments),this.elpar=.4,this.name="elastic",this.bounce=t=>{if(e.assert(3==t.shape[0]),this.Stuff){let s=this.Stuff.getComponent("mechanics"),n=s.getState("V");e.assert(0!=t.norm().asScalar().arraySync(),"错误，轴不能为0");let i=n.mul(t).sum().div(t.norm()).mul(t.div(t.norm()));e.assert(0!=i.norm().asScalar().arraySync(),"错误，不能与速度方向垂直");let r=n.sub(i.mul(1+this.elpar));e.assert(1==r.rank,"计算结果中维度错误 ，请调试:"+r.rank),s.setState(null,r)}},this.exports={bounce:this.bounce}}beforeAttach(t){super.beforeAttach(t)}render(t){this._stuff}}class g extends f{constructor(){super(...arguments),this.name="gravity",this.G=667e-13,this.nowUseGravity=t([3]),this.useGravity=t=>{e.assert(3==t.shape[0]),this.nowUseGravity=this.nowUseGravity.add(t)},this.applyGravity=()=>{var t;let e=null==(t=this.Stuff)?void 0:t.getComponent("mechanics");e&&e.addF(this.nowUseGravity)},this.clearGravity=()=>{if(null!=this.nowUseGravity){if(this.Stuff){this.Stuff.getComponent("mechanics").addF(this.nowUseGravity.mul(-1))}this.nowUseGravity.dispose(),this.nowUseGravity=t([3])}else this.nowUseGravity=t([3])},this.exports={setG:t=>{this.G=t}}}beforeAttach(t){super.beforeAttach(t)}render(t){if(null!=this._stuff&&null!=this.Stuff&&this.Stuff.Context){this.clearGravity();let t=this.Stuff.Context.getStuffWithComponents(["gravity"]),s=this.Stuff.getComponent("mechanics").getM(),n=this.Stuff.getComponent("render").getPosition(),r=this.G;for(let a of t){if(a==this._stuff)continue;let t=new c(a),h=t.getComponent("render"),l=t.getComponent("mechanics"),u=o((()=>{let t=h.getPosition().sub(n),o=t.div(t.norm()),a=t.norm(),u=l.getM(),c=i(r*(s*u)).div(a.pow(2)).mul(o);return e.assert(1==c.rank,"重力维度错误"),c}));this.useGravity(u)}this.applyGravity()}}}class y extends class extends class{constructor(t,e){this.element=t,this.components=e,this.context=null}beforeRegister(t){this.context=t;for(let e of this.components.values())e.stuffBeforeRegister&&e.stuffBeforeRegister(t)}render(t){if(null!=this.context)for(let e of this.components.values())e.render(t)}}{constructor(){super(function(){let t=document.createElement("div");return t.style.position="absolute",null==l||l.appendChild(t),t}(),new Map),this.Operations=new c(this),this.waitAttatches=[]}isRequirementsOk(t){return!0}addWaitingComponent(t){this.waitAttatches.push(t)}attachComponent(t){this.isRequirementsOk(t)?(t.beforeAttach&&t.beforeAttach(this),this.components.set(t.name,t)):this.addWaitingComponent(t)}}{constructor(t,e,s){super(),this.attachComponent(new p),this.attachComponent(new w),this.attachComponent(new m),this.attachComponent(new d),this.attachComponent(new g);let n=this.Operations.getComponent("mechanics");n.setState(i(s),i(e),i([0,0,0]),i([0,0,0])),n.setM(t),this.Operations.getComponent("gravity")}render(t){super.render(t),this.Operations.getComponent("render").setSize(i([10,10]))}}a("cpu");const S=new class{constructor(){this.listofStuff=[],this.renderEndEvents=[]}register(t){null!=t.beforeRegister&&t.beforeRegister(this),this.listofStuff.push(t)}getStuffWithComponents(t){return this.listofStuff.filter((e=>{let s=!0;for(let n of t){let t=!1;for(let s of e.components)if(s[1].name==n){t=!0;break}if(0==t){s=!1;break}}return s}))}};class w extends f{constructor(){super(...arguments),this.exports={},this.name="colorchange"}render(t){null!=this._stuff&&(this._stuff.element.style.backgroundColor="red")}}!async function(){let t=null;function s(){if(null==t)return t=h(),null;{let e=h(new Date),s=e.diff(t);return t=e,s}}let n=0;for(;;){u.innerText=n.toString(),n++,await e.delay(16);let t=s();requestAnimationFrame((e=>{for(let s of S.listofStuff)s.render(t)}))}}();let x=document.querySelector("button");x&&(x.onclick=function(){let t=500*(Math.random()+.5);S.register(new y(1e17*(Math.random()+.5),[0*(Math.random()+.5),0,0],[t,t,0])),S.register(new y(1e10*(Math.random()+.5),[100*(Math.random()+.5),0,0],[t,Math.random()*(t+50),0]))});
